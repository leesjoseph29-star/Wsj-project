<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order & Donation Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main);
            padding: 40px; 
            margin: 0;
        }

        header { margin-bottom: 32px; }
        h1 { font-size: 26px; font-weight: 700; margin: 0; letter-spacing: -0.02em; }

        /* Dashboard Metrics */
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-bottom: 32px; 
        }

        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .card h3 { margin: 0; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .card p { font-size: 24px; font-weight: 700; margin: 8px 0 0 0; }

        .progress-container { background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden; margin-top: 12px; }
        .progress-bar { height: 100%; width: 0%; background: var(--success); transition: width 0.6s ease; }

        /* Form Section */
        .panel { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .panel h2 { font-size: 16px; margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .input-group { display: flex; gap: 12px; flex-wrap: wrap; }

        input, select, button { 
            padding: 10px 16px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            font-size: 14px;
            outline: none;
        }

        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            font-weight: 600; 
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background: var(--primary-hover); }
        
        .btn-outline { background: white; color: var(--text-main); border: 1px solid var(--border); }
        .btn-outline:hover { background: #f8fafc; }

        .delete-btn { background: #fee2e2; color: #b91c1c; border: none; padding: 6px 12px; font-size: 12px; }
        .delete-btn:hover { background: #fecaca; }

        /* Table Structure */
        .table-wrapper { 
            background: var(--card-bg); 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            overflow: hidden; 
            margin-bottom: 32px;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 14px 20px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        tr.donation-row { background-color: #f0fdf4; }

        /* Chart Section */
        .chart-container { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
        }
        canvas { max-height: 300px; }
    </style>
</head>
<body>

<header>
    <h1>Management Dashboard</h1>
</header>

<div class="dashboard">
    <div class="card">
        <h3>Total Revenue</h3>
        <p>£<span id="totalRevenue">0.00</span></p>
    </div>
    <div class="card">
        <h3>Total Paid</h3>
        <p>£<span id="totalPaid">0.00</span></p>
    </div>
    <div class="card">
        <h3>Total Unpaid</h3>
        <p>£<span id="totalUnpaid">0.00</span></p>
    </div>
    <div class="card">
        <h3>Total Badges Sewn</h3>
        <p id="totalBadges">0</p>
    </div>
    <div class="card">
        <h3>Goal Fulfillment (£4,000)</h3>
        <p><span id="percentage">0</span>%</p>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    </div>
</div>

<div class="panel">
    <h2>Add New Entry</h2>
    <div class="input-group">
        <select id="entryType" onchange="toggleEntryType()">
            <option value="order">Standard Order</option>
            <option value="donation">Direct Donation</option>
        </select>
        <input type="text" id="newName" placeholder="Name">
        <input type="number" id="newBadges" placeholder="Number of Badges">
        <input type="number" step="0.01" id="newExtra" placeholder="Extra / Amount (£)">
        <button onclick="addEntry()">Submit Entry</button>
    </div>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <input type="text" id="searchInput" placeholder="Search entries..." style="width: 280px;">
    <button class="btn-outline" onclick="exportToExcel()">Export to Excel</button>
</div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Badges</th>
                <th>Extra (£)</th>
                <th>Total (£)</th>
                <th>Paid</th>
                <th>Completion Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="orderTable"></tbody>
    </table>
</div>

<div class="chart-container">
    <h2>Monthly Revenue (By Completion Date)</h2>
    <canvas id="revenueChart"></canvas>
</div>

<script>
const goal = 4000;
const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let entries = JSON.parse(localStorage.getItem("business_ledger")) || [];

function saveData() { localStorage.setItem("business_ledger", JSON.stringify(entries)); }

function toggleEntryType() {
    const type = document.getElementById("entryType").value;
    const badgeInput = document.getElementById("newBadges");
    if (type === "donation") {
        badgeInput.value = 0;
        badgeInput.disabled = true;
        badgeInput.style.backgroundColor = "#f1f5f9";
    } else {
        badgeInput.disabled = false;
        badgeInput.style.backgroundColor = "white";
    }
}

function calculateMonthlyTotals() {
    let totals = {};
    monthNames.forEach(m => totals[m] = 0);
    entries.forEach(e => {
        if (e.completionDate) {
            const date = new Date(e.completionDate);
            const month = monthNames[date.getMonth()];
            totals[month] += e.total;
        }
    });
    return totals;
}

function updateDashboard() {
    const totalRev = entries.reduce((s, e) => s + e.total, 0);
    const totalPaid = entries.filter(e => e.paid).reduce((s, e) => s + e.total, 0);
    const unpaidRev = totalRev - totalPaid;

    const completedEntries = entries.filter(e => e.completionDate);
    const compRev = completedEntries.reduce((s, e) => s + e.total, 0);
    const totalBadges = completedEntries.reduce((s, e) => s + (parseInt(e.badges) || 0), 0);
    
    const percent = Math.min((compRev / goal) * 100, 100);

    document.getElementById("totalRevenue").innerText = totalRev.toFixed(2);
    document.getElementById("totalPaid").innerText = totalPaid.toFixed(2);
    document.getElementById("totalUnpaid").innerText = unpaidRev.toFixed(2);
    document.getElementById("totalBadges").innerText = totalBadges;
    document.getElementById("percentage").innerText = percent.toFixed(1);
    document.getElementById("progressBar").style.width = percent + "%";
}

function renderEntries() {
    const table = document.getElementById("orderTable");
    const search = document.getElementById("searchInput").value.toLowerCase();
    table.innerHTML = "";

    entries.forEach((entry, index) => {
        if (entry.name.toLowerCase().includes(search)) {
            const isDonation = entry.type === 'donation';
            table.innerHTML += `
                <tr class="${isDonation ? 'donation-row' : ''}">
                    <td style="font-weight:600; font-size:12px; color:var(--text-muted)">${entry.type.toUpperCase()}</td>
                    <td><strong>${entry.name}</strong></td>
                    <td>${isDonation ? '-' : entry.badges}</td>
                    <td>£${entry.extra.toFixed(2)}</td>
                    <td>£${entry.total.toFixed(2)}</td>
                    <td><input type="checkbox" ${entry.paid ? "checked" : ""} onchange="togglePaid(${index})"></td>
                    <td><input type="date" value="${entry.completionDate || ''}" onchange="updateDate(${index}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>
                </tr>`;
        }
    });
    updateDashboard();
    updateChart();
}

function addEntry() {
    const type = document.getElementById("entryType").value;
    const name = document.getElementById("newName").value;
    const badges = parseInt(document.getElementById("newBadges").value) || 0;
    const extra = parseFloat(document.getElementById("newExtra").value) || 0;

    if (!name) return alert("Enter a name.");

    const total = type === 'donation' ? extra : (badges * 0.5) + extra;

    entries.push({ type, name, badges, extra, total, paid: false, completionDate: "" });
    saveData();
    renderEntries();
    
    document.getElementById("newName").value = "";
    document.getElementById("newBadges").value = "";
    document.getElementById("newExtra").value = "";
}

function togglePaid(index) { entries[index].paid = !entries[index].paid; saveData(); updateDashboard(); }
function updateDate(index, value) { entries[index].completionDate = value; saveData(); renderEntries(); }
function deleteEntry(index) { if(confirm("Permanently delete this entry?")) { entries.splice(index, 1); saveData(); renderEntries(); } }

const ctx = document.getElementById("revenueChart").getContext("2d");
let revenueChart = new Chart(ctx, {
    type: 'bar', 
    data: { 
        labels: monthNames, 
        datasets: [{ label: 'Revenue (£)', data: [], backgroundColor: '#2563eb', borderRadius: 4 }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
    }
});

function updateChart() {
    const totals = calculateMonthlyTotals();
    revenueChart.data.datasets[0].data = monthNames.map(m => totals[m]);
    revenueChart.update();
}

function exportToExcel() {
    if(entries.length === 0) return;
    const ws = XLSX.utils.json_to_sheet(entries);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Audit_Log");
    XLSX.writeFile(wb, "Business_Data.xlsx");
}

document.getElementById("searchInput").addEventListener("input", renderEntries);
renderEntries();
</script>
</body>
</html>
