<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order & Donation Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main);
            padding: 30px; 
            margin: 0;
        }

        header { margin-bottom: 24px; }
        h1 { font-size: 22px; font-weight: 700; margin: 0; letter-spacing: -0.02em; }

        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 24px; 
        }

        .card { 
            background: var(--card-bg); 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .card h3 { margin: 0; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .card p { font-size: 20px; font-weight: 700; margin: 5px 0 0 0; }

        .progress-container { background: #e2e8f0; border-radius: 10px; height: 6px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; width: 0%; background: var(--success); transition: width 0.6s ease; }

        .panel { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .panel h2 { font-size: 14px; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }

        .input-group { display: flex; gap: 10px; flex-wrap: wrap; }

        input, select, button { 
            padding: 8px 12px; 
            border-radius: 6px; 
            border: 1px solid var(--border); 
            font-size: 13px;
            outline: none;
        }

        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            font-weight: 600; 
            cursor: pointer;
        }

        .btn-outline { background: white; color: var(--text-main); border: 1px solid var(--border); }

        .delete-btn { background: #fee2e2; color: #b91c1c; border: none; padding: 4px 8px; font-size: 11px; border-radius: 4px; cursor: pointer; }

        .table-wrapper { 
            background: var(--card-bg); 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            overflow: hidden; 
            margin-bottom: 24px;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 12px 15px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 13px; }
        
        tr.donation-row { background-color: #f0fdf4; }

        /* Monthly Summary Table Styling */
        .summary-container {
            max-width: 400px; /* Kept small as requested */
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .summary-header {
            padding: 12px 15px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<header>
    <h1>Management Dashboard</h1>
</header>

<div class="dashboard">
    <div class="card">
        <h3>Total Revenue</h3>
        <p>£<span id="totalRevenue">0.00</span></p>
    </div>
    <div class="card">
        <h3>Total Paid</h3>
        <p>£<span id="totalPaid">0.00</span></p>
    </div>
    <div class="card">
        <h3>Total Unpaid</h3>
        <p>£<span id="totalUnpaid">0.00</span></p>
    </div>
    <div class="card">
        <h3>Badges Sewn</h3>
        <p id="totalBadges">0</p>
    </div>
    <div class="card">
        <h3>Goal (£4,000)</h3>
        <p><span id="percentage">0</span>%</p>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    </div>
</div>

<div class="panel">
    <h2>Add New Entry</h2>
    <div class="input-group">
        <select id="entryType" onchange="toggleEntryType()">
            <option value="order">Standard Order</option>
            <option value="donation">Direct Donation</option>
        </select>
        <input type="text" id="newName" placeholder="Name">
        <input type="number" id="newBadges" placeholder="Badges (50p)">
        <input type="number" step="0.01" id="newExtra" placeholder="Additional Payment (£)">
        <button onclick="addEntry()">Submit Entry</button>
    </div>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
    <input type="text" id="searchInput" placeholder="Search entries..." style="width: 200px;">
    <button class="btn-outline" onclick="exportToExcel()">Export Excel</button>
</div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Badges</th>
                <th>Badge Cost</th>
                <th>Add. Payment</th>
                <th>Total (£)</th>
                <th>Paid</th>
                <th>Completion</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="orderTable"></tbody>
    </table>
</div>

<div class="summary-container">
    <div class="summary-header">Monthly Payment Summary</div>
    <table id="monthlySummaryTable">
        <thead>
            <tr>
                <th>Month</th>
                <th>Payment Received</th>
            </tr>
        </thead>
        <tbody id="summaryBody">
            </tbody>
    </table>
</div>

<script>
const goal = 4000;
const badgeRate = 0.50;
const monthLongNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
let entries = JSON.parse(localStorage.getItem("business_ledger")) || [];

function saveData() { localStorage.setItem("business_ledger", JSON.stringify(entries)); }

function toggleEntryType() {
    const type = document.getElementById("entryType").value;
    const badgeInput = document.getElementById("newBadges");
    badgeInput.disabled = (type === "donation");
    badgeInput.style.backgroundColor = (type === "donation") ? "#f1f5f9" : "white";
    if(type === "donation") badgeInput.value = 0;
}

function updateDashboard() {
    const totalRev = entries.reduce((s, e) => s + e.total, 0);
    const totalPaid = entries.filter(e => e.paid).reduce((s, e) => s + e.total, 0);
    const unpaidRev = totalRev - totalPaid;

    const completedEntries = entries.filter(e => e.completionDate);
    const compRev = completedEntries.reduce((s, e) => s + e.total, 0);
    const totalBadges = completedEntries.reduce((s, e) => s + (parseInt(e.badges) || 0), 0);
    
    const percent = Math.min((compRev / goal) * 100, 100);

    document.getElementById("totalRevenue").innerText = totalRev.toFixed(2);
    document.getElementById("totalPaid").innerText = totalPaid.toFixed(2);
    document.getElementById("totalUnpaid").innerText = unpaidRev.toFixed(2);
    document.getElementById("totalBadges").innerText = totalBadges;
    document.getElementById("percentage").innerText = percent.toFixed(1);
    document.getElementById("progressBar").style.width = percent + "%";
}

function renderEntries() {
    const table = document.getElementById("orderTable");
    const search = document.getElementById("searchInput").value.toLowerCase();
    table.innerHTML = "";

    entries.forEach((entry, index) => {
        if (entry.name.toLowerCase().includes(search)) {
            const isDonation = entry.type === 'donation';
            const badgeCost = isDonation ? 0 : (entry.badges * badgeRate);
            
            table.innerHTML += `
                <tr class="${isDonation ? 'donation-row' : ''}">
                    <td style="font-size:10px; color:var(--text-muted)">${entry.type.toUpperCase()}</td>
                    <td><strong>${entry.name}</strong></td>
                    <td>${isDonation ? '-' : entry.badges}</td>
                    <td>${isDonation ? '-' : '£' + badgeCost.toFixed(2)}</td>
                    <td>£${entry.extra.toFixed(2)}</td>
                    <td><strong>£${entry.total.toFixed(2)}</strong></td>
                    <td><input type="checkbox" ${entry.paid ? "checked" : ""} onchange="togglePaid(${index})"></td>
                    <td><input type="date" value="${entry.completionDate || ''}" onchange="updateDate(${index}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteEntry(${index})">Del</button></td>
                </tr>`;
        }
    });
    updateDashboard();
    renderSummary();
}

function renderSummary() {
    const summaryBody = document.getElementById("summaryBody");
    summaryBody.innerHTML = "";
    
    let monthlyMap = {};

    // Only process entries that have a completion date
    entries.forEach(e => {
        if (e.completionDate) {
            const dateObj = new Date(e.completionDate);
            const label = `${monthLongNames[dateObj.getMonth()]}-${dateObj.getFullYear()}`;
            monthlyMap[label] = (monthlyMap[label] || 0) + e.total;
        }
    });

    const sortedMonths = Object.keys(monthlyMap);
    
    if (sortedMonths.length === 0) {
        summaryBody.innerHTML = "<tr><td colspan='2' style='color:var(--text-muted); text-align:center;'>No completions recorded</td></tr>";
        return;
    }

    sortedMonths.forEach(month => {
        summaryBody.innerHTML += `
            <tr>
                <td>${month}</td>
                <td><strong>£${monthlyMap[month].toFixed(2)}</strong></td>
            </tr>
        `;
    });
}

function addEntry() {
    const type = document.getElementById("entryType").value;
    const name = document.getElementById("newName").value;
    const badges = parseInt(document.getElementById("newBadges").value) || 0;
    const extra = parseFloat(document.getElementById("newExtra").value) || 0;

    if (!name) return alert("Enter a name.");
    const total = type === 'donation' ? extra : (badges * badgeRate) + extra;

    entries.push({ type, name, badges, extra, total, paid: false, completionDate: "" });
    saveData();
    renderEntries();
    
    document.getElementById("newName").value = "";
    document.getElementById("newBadges").value = "";
    document.getElementById("newExtra").value = "";
}

function togglePaid(index) { entries[index].paid = !entries[index].paid; saveData(); updateDashboard(); renderSummary(); }
function updateDate(index, value) { entries[index].completionDate = value; saveData(); renderEntries(); }
function deleteEntry(index) { if(confirm("Delete?")) { entries.splice(index, 1); saveData(); renderEntries(); } }

function exportToExcel() {
    if(entries.length === 0) return;
    const ws = XLSX.utils.json_to_sheet(entries);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Logs");
    XLSX.writeFile(wb, "Business_Data_Export.xlsx");
}

document.getElementById("searchInput").addEventListener("input", renderEntries);
renderEntries();
</script>
</body>
</html>
